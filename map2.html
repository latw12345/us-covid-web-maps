<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>COVID-19 Cases in the U.S.</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

    <link href="https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; padding: 0; font-family: 'Open Sans', sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        #legend {
            position: absolute; bottom: 0; right: 0; width: 110px;
            background: #555554; margin-right: 20px; margin-bottom: 40px;
            padding: 10px; border-radius: 3px; text-align: left; color: white;
        }

        #title {
            position: absolute; top: 0; left: 0; margin: 20px;
            font-size: 25pt; color: white;
        }
        #subtitle {
            position: absolute; top: 0; left: 0; margin: 70px 0 0 20px;
            font-size: 15pt; color: white;
        }

        .break { position: relative; margin: 0; padding: 0; }
        .dot { display: inline-block; margin-top: 5px; opacity: 0.6; }
        .dot-label { position: absolute; top: 0; right: 0; font-style: italic; }

        a { color: white; }

        #searchBox {
            position: absolute; top: 70px; right: 20px;
            display: flex; gap: 6px; z-index: 5;
        }
        #countySearch {
            padding: 8px; width: 210px; border-radius: 4px; border: none; outline: none; font-family: Open Sans;
        }
        #searchBtn {
            padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-family: Open Sans;
        }

        #toggleLabels {
            position: absolute; top: 20px; right: 20px;
            padding: 8px 12px; border-radius: 4px; border: none; cursor: pointer; font-family: Open Sans;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="legend"></div>
    <div id="title">COVID-19 Cases in the U.S.</div>
    <div id="subtitle">on December 31st, 2020</div>

    <div id="searchBox">
        <input id="countySearch" type="text" placeholder="County, State (King, Washington)">
        <button id="searchBtn">Search</button>
    </div>
    <button id="toggleLabels">Toggle Labels</button>

    <script>
        const grades = [10000, 50000, 100000, 400000, 800000];
        const grades_labels = ['10k', '50k', '100k', '400k', '800k'];
        const colors = ['#fef0d9', '#fdcc8a', '#fc8d59', '#e34a33', '#b30000']; 
        const radii = [2, 5, 7, 13, 18];

        mapboxgl.accessToken = 'pk.eyJ1IjoibGlhbnM3NyIsImEiOiJjbWt6NGxhMjcwZTJsM2Vwd2RtbWVvZHRuIn0.HDVAEM1yBC3D51XX3B4NPw';

        let map = new mapboxgl.Map({
            container: 'map',
            projection: 'albers',
            style: 'mapbox://styles/mapbox/dark-v10',
            zoom: 3.6,
            minZoom: 3,
            maxZoom: 9,
            center: [-98, 39]
        });

        let countyData;

        map.on('load', async () => {
            const response = await fetch('assets/us-covid-2020-rates.json');
            countyData = await response.json();

            map.addSource('county-boundaries', { type: 'geojson', data: countyData });

            const response2 = await fetch('assets/us-covid-2020-counts.json');
            pointData = await response2.json();

            map.addSource('county-points', { type: 'geojson', data: pointData });

            map.addLayer({
                id: 'county-lines',
                type: 'line',
                source: 'county-boundaries',
                paint: { 'line-color': '#555554', 'line-width': 0.5 }
            });

            map.addLayer({
                id: 'county-highlight',
                type: 'line',
                source: 'county-boundaries',
                paint: { 'line-color': '#00ffff', 'line-width': 3 },
                filter: ['==', 'county', '']
            });

            map.addLayer({
                id: 'covid-points-layer',
                type: 'circle',
                source: 'county-points',
                paint: {
                    'circle-radius': [
                        'interpolate',
                        ['exponential', 1.5],
                        ['zoom'],
                        3, ['interpolate', ['linear'], ['get', 'cases'],
                            grades[0], radii[0] * 0.6,
                            grades[1], radii[1] * 0.6,
                            grades[2], radii[2] * 0.6,
                            grades[3], radii[3] * 0.6,
                            grades[4], radii[4] * 0.6
                        ],
                        9, ['interpolate', ['linear'], ['get', 'cases'],
                            grades[0], radii[0] * 9,
                            grades[1], radii[1] * 9,
                            grades[2], radii[2] * 9,
                            grades[3], radii[3] * 9,
                            grades[4], radii[4] * 9
                        ]
                    ],

                    'circle-color': [
                        'interpolate',
                        ['linear'],
                        ['get', 'cases'],
                        grades[0], colors[0],
                        grades[1], colors[1],
                        grades[2], colors[2],
                        grades[3], colors[3],
                        grades[4], colors[4]
                    ],

                    'circle-opacity': 0.6,
                    'circle-stroke-color': 'white',
                    'circle-stroke-width': 0.2
                }
            });

            map.on('click', 'covid-points-layer', (e) => {
                const props = e.features[0].properties;
                new mapboxgl.Popup({ closeOnClick: false, closeButton: true })
                    .setLngLat(e.lngLat)
                    .setHTML(`<strong>${props.county}, ${props.state}</strong><br>Cases: ${props.cases.toLocaleString()}`)
                    .addTo(map);
            });

            let symbolsHidden = false;
            const toggleBtn = document.getElementById('toggleLabels');
            toggleBtn.addEventListener('click', () => symbolsHidden ? showSymbols() : hideSymbols());

            function hideSymbols() {
                map.getStyle().layers.forEach(layer => {
                    if (layer.type === 'symbol' && map.getLayer(layer.id)) {
                        map.setPaintProperty(layer.id, 'text-opacity', 0);
                        map.setPaintProperty(layer.id, 'icon-opacity', 0);
                    }
                });
                toggleBtn.innerText = 'Show Labels';
                symbolsHidden = true;
            }

            function showSymbols() {
                map.getStyle().layers.forEach(layer => {
                    if (layer.type === 'symbol' && map.getLayer(layer.id)) {
                        map.setPaintProperty(layer.id, 'text-opacity', 1);
                        map.setPaintProperty(layer.id, 'icon-opacity', 1);
                    }
                });
                toggleBtn.innerText = 'Hide Labels';
                symbolsHidden = false;
            }

            hideSymbols();

            const input = document.getElementById('countySearch');
            const button = document.getElementById('searchBtn');

            function normalize(text) { return text.toLowerCase().trim(); }

            button.addEventListener('click', () => {
                const value = normalize(input.value);
                if (!value.includes(',')) {
                    alert("Use format: County, State\nExample: King, Washington");
                    return;
                }

                const [inputCountyRaw, inputStateRaw] = value.split(',');
                const inputCounty = normalize(inputCountyRaw);
                const inputState = normalize(inputStateRaw);

                const match = countyData.features.find(f =>
                    normalize(f.properties.county) === inputCounty &&
                    normalize(f.properties.state) === inputState
                );

                if (!match) {
                    alert("County not found.\nExample: King, Washington");
                    return;
                }

                map.fitBounds(turf.bbox(match), { padding: 40, duration: 4000 });
                map.setFilter('county-highlight', [
                    'all',
                    ['==', ['get', 'county'], match.properties.county],
                    ['==', ['get', 'state'], match.properties.state]
                ]);
            });
        });

        const legend = document.getElementById('legend');
        let labels = ['<strong>Cases</strong>'];
        for (let i = 0; i < grades.length; i++) {
            const dot_size = 2 * radii[i];
            labels.push(
                `<p class="break"><i class="dot" style="background:${colors[i]}; width:${dot_size}px; height:${dot_size}px; border-radius:50%; display:inline-block; margin-right:5px;"></i>` +
                `<span class="dot-label" style="top:${dot_size / 2}px;">${grades_labels[i]}</span></p>`
            );
        }
        legend.innerHTML = labels.join('') + `
            <p style="text-align:right; font-size:6pt">
                Sources:<br>
                <a href="https://github.com/nytimes/covid-19-data/blob/43d32dde2f87bd4dafbb7d23f5d9e878124018b8/live/us-counties.csv" target="_blank">The New York Times</a><br>
                <a href="https://data.census.gov/table/ACSDP5Y2018.DP05?g=0100000US$050000&d=ACS+5-Year+Estimates+Data+Profiles&hidePreview=true" target="_blank">2018 ACS 5 Year Estimates</a><br>
                <a href="https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html" target="_blank">The U.S. Census Bureau</a>
            </p>`;
    </script>
</body>
</html>